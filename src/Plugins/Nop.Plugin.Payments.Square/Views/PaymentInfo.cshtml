@model Nop.Plugin.Payments.Square.Models.PaymentInfoModel
@{
    Layout = "";
}
@inject Nop.Plugin.Payments.Square.SquarePaymentSettings squarePaymentSettings
      
<table width="100%" cellspacing="2" cellpadding="1" border="0">
    <tr>
        <td>
            <label asp-for="StoredCardId">@T("Plugins.Payments.Square.Fields.StoredCard"):</label>
        </td>
        <td>
            <select asp-for="StoredCardId" asp-items="Model.StoredCards" class="dropdownlists"></select>
        </td>
    </tr>
</table>

<script type="text/javascript">
    $(document).ready(function () {
        $('#@Html.IdFor(model => model.StoredCardId)').change(toggleStoredCard);
        toggleStoredCard();

        $.getScript('https://js.squareup.com/v2/paymentform', function (data, textStatus, jqxhr) {
            var paymentForm = new SqPaymentForm({
                applicationId: '@squarePaymentSettings.ApplicationId',
                inputClass: 'square-input',
                inputStyles: [{
                    fontSize: '15px'
                }
                ],
                cardNumber: {
                    elementId: 'square-card-number',
                    placeholder: '•••• •••• •••• ••••'
                },
                expirationDate: {
                    elementId: 'square-expiration-date',
                    placeholder: 'MM/YY'
                },
                cvv: {
                    elementId: 'square-cvv',
                    placeholder: 'CVV'
                },
                postalCode: {
                    elementId: 'square-postal-code'
                },
                callbacks: {
                    //called when the SqPaymentForm completes a request to generate a card nonce, even if the request failed because of an error.
                    cardNonceResponseReceived: function (errors, nonce, cardData) {
                        if (errors) {
                            errors.forEach(function (error) {
                                console.log(error.message);
                            });
                        }
                        else {
                            $('#@Html.IdFor(model => model.CardNonce)').val(nonce);
                            //paymentForm.destroy();
                        }
                    },

                    unsupportedBrowserDetected: function () {
                        console.log('Browser is not supported');
                    },

                    paymentFormLoaded: function () {
                        //setting the postal code field programmatically
                        paymentForm.setPostalCode('@Model.PostalCode');
                    }
                }
            });
            paymentForm.build();

            $('input.payment-info-next-step-button').on('click', function (data) {
                var selectedStoredCardId = $('#@Html.IdFor(model => model.StoredCardId)').val();
                if (!selectedStoredCardId || selectedStoredCardId == '0') {
                    paymentForm.requestCardNonce();
                }
            });
        });
    });

    function toggleStoredCard() {
        var selectedStoredCardId = $('#@Html.IdFor(model => model.StoredCardId)').val();
        if (!selectedStoredCardId || selectedStoredCardId == '0') {
            $('#square-card-details').show();
        } else {
            $('#square-card-details').hide();
        }
    }
</script>
   
@*After the SqPaymentForm generates a card nonce, it's assigned as the value of this hidden input field.*@
<input type="hidden" asp-for="CardNonce">

@*These div elements are the placeholder elements that are replaced by the SqPaymentForm's iframes.*@
<table width="100%" cellspacing="2" cellpadding="1" border="0" id="square-card-details">
    <tr>
        <td>
            <label>@T("Payment.CardNumber"):</label>
        </td>
        <td>
            <div id="square-card-number" style="width:165px;"></div>
        </td>
    </tr>
    <tr>
        <td>
            <label>@T("Payment.ExpirationDate"):</label>
        </td>
        <td>
            <div id="square-expiration-date"></div>
        </td>
    </tr>
    <tr>
        <td>
            <label>@T("Payment.CardCode"):</label>
        </td>
        <td>
            <div id="square-cvv" style="width:60px;"></div>
        </td>
    </tr>
    <tr>
        <td>
            <label asp-for="PostalCode">@T("Plugins.Payments.Square.Fields.PostalCode"):</label>
        </td>
        <td>
            <div id="square-postal-code"></div>
        </td>
    </tr>
    <tr>
        <td>
            <label asp-for="SaveCard">@T("Plugins.Payments.Square.Fields.SaveCard"):</label>
        </td>
        <td>
            <input type="checkbox" asp-for="SaveCard"/>
            <span asp-validation-for="SaveCard"></span>
        </td>
    </tr>
</table>